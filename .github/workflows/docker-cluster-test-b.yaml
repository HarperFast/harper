name: "Run Docker Cluster Tests B"

on:
  workflow_dispatch:
    inputs:
      files:
        description: 'list of container files to test'
        default: '["utility/Docker/Dockerfile","utility/Docker/Dockerfile-openshift"]'
        type: choice
        options:
          - '["utility/Docker/Dockerfile","utility/Docker/Dockerfile-openshift"]'
          - '["utility/Docker/Dockerfile"]'
          - '["utility/Docker/Dockerfile-openshift"]'
      platforms:
        description: 'list of platforms to test'
        default: '["linux/amd64","linux/arm64"]'
        type: choice
        options:
          - '["linux/amd64","linux/arm64"]'
          - '["linux/amd64"]'
          - '["linux/arm64"]'
  workflow_call:
    inputs:
      files:
        description: 'list of container files to test'
        default: '["utility/Docker/Dockerfile","utility/Docker/Dockerfile-openshift"]'
        type: string
      platforms:
        description: 'list of platforms to test'
        default: '["linux/amd64","linux/arm64"]'
        type: string

jobs:
  ####################
  #  Build HarperDB
  ####################
  build:
    uses: ./.github/workflows/build.yaml

  ##############################
  #  Call Docker Test template
  #    cluster test b
  #############################
  cluster-test-b:
    needs:
      - build
    uses: ./.github/workflows/docker-cluster-test.yaml
    strategy:
      fail-fast: false
      matrix:
        file: ${{ fromJSON(inputs.files) || '["utility/Docker/Dockerfile","utility/Docker/Dockerfile-openshift"]'}}
        platform: ${{ fromJSON(inputs.platforms) }}
    with:
      harperdbVersion: ${{ needs.build.outputs.harperdbVersion }}
      file: ${{ matrix.file }}
      platform: ${{ matrix.platform }}
      clusterTest: 'test/ci-tests/docker-cluster-test-b.sh'
    secrets: inherit
