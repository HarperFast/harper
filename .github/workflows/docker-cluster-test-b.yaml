name: 'Run Docker Cluster Tests B'

on:
  workflow_dispatch:
    inputs:
      flavors:
        description: 'list of containers to test'
        default: '["standard","openshift"]'
        type: choice
        options:
          - '["standard","openshift"]'
          - '["standard"]'
          - '["openshift"]'
      platforms:
        description: 'list of platforms to test'
        default: '["amd64","arm64"]'
        type: choice
        options:
          - '["amd64","arm64"]'
          - '["amd64"]'
          - '["arm64"]'
  workflow_call:
    inputs:
      flavors:
        description: 'list of containers to test'
        default: '["standard","openshift"]'
        type: string
      platforms:
        description: 'list of platforms to test'
        default: '["amd64","arm64"]'
        type: string

jobs:
  ####################
  #  Build HarperDB
  ####################
  build:
    uses: ./.github/workflows/build.yaml

  ##########################
  #  Build Container Image
  ##########################
  dockerBuild:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        flavor: ${{ fromJSON(inputs.flavors) }}
        platform: ${{ fromJSON(inputs.platforms) }}
        include:
          - flavor: 'standard'
            file: 'utility/Docker/Dockerfile'
          - flavor: 'openshift'
            file: 'utility/Docker/Dockerfile-openshift'
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo
        uses: actions/checkout@v4
      - name: docker-build
        uses: ./.github/docker-build
        with:
          harperdbVersion: ${{ needs.build.outputs.harperdbVersion }}
          containerImage: 'tar'
          containerTarball: docker-harperdb_${{ needs.build.outputs.harperdbVersion }}-${{ matrix.flavor }}-${{ matrix.platform }}-${{ github.run_number }}.tar
          dockerFile: ${{ matrix.file }}
          buildPlatforms: 'linux/${{ matrix.platform }}'

  ##############################
  #  Call Docker Test template
  #    cluster test b
  #############################
  cluster-test-b:
    needs:
      - build
      - dockerBuild
    uses: ./.github/workflows/docker-cluster-test.yaml
    strategy:
      fail-fast: false
      matrix:
        flavor: ${{ fromJSON(inputs.flavors) }}
        platform: ${{ fromJSON(inputs.platforms) }}
    with:
      harperdbVersion: ${{ needs.build.outputs.harperdbVersion }}
      clusterTest: 'test/ci-tests/docker-cluster-test-b.sh'
      dockerArtifactSuffix: '${{ matrix.flavor }}-${{ matrix.platform }}-${{ github.run_number }}'
    secrets: inherit
